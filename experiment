#!/usr/bin/env bash
#set -x

#check the files are tab seperated
#report any lines that do not have the same number of cells to stderr
#clean the data - date ranges, code column is empty
#determine which files contain which data (homicides will only have NF = 4)

#sort files according to entity (column 1)
#create and store key:val array for entity and year
#create a tab separate file containing the header list outlined in asssignment
#use the key:val array to refernce the rows in the cleaned files to build the new data file
#remove temp files

for arg in "$@"
do
    sed -n '1p' $arg > header_extract.tsv
    if grep -E -q [Ll]ife header_extract.tsv
    then
        echo In "$arg"
        awk -F'\t' '(int($3) < 2011 || int($3) > 2021) || $2 == ""{next;}{print $0}' $arg | sort -k1 -k3,3n | cut -f1-6 > "_life.tsv"
        awk 'BEGIN{FS="\t"; OFS=FS}{$7=$2$3}1' _life.tsv | sort -k7 > _tmplife.tsv
    elif grep -E -q [Gg][Dd][Pp] header_extract.tsv
    then
        echo In "$arg"
        awk -F'\t' '(int($3) < 2011 || int($3) > 2021) || $2 == ""{next;}{print $0}' $arg | sort -k1 -k3,3n | cut -f1-6 > "_gdp.tsv"
        awk 'BEGIN{FS="\t"; OFS=FS}{$7=$2$3}1' _gdp.tsv | sort -k7 > _tmpgdp.tsv
    elif grep -q [Hh]omicide header_extract.tsv
    then
        echo In "$arg"
        awk -F'\t' '(int($3) < 2011 || int($3) > 2021) || $2 == ""{next;}{print $0}' $arg | sort -k1 -k3,3n | cut -f1-4 > "_homicide.tsv"
        awk 'BEGIN{FS="\t"; OFS=FS}{$5=$2$3}1' _homicide.tsv | sort -k5 > _tmphomicide.tsv
    fi
#TODO remove header_extract.tsv
done

join -j7 -o 1.1 1.2 1.3 2.1 2.2 _tmplife.tsv _tmpgdp.tsv > merged.tsv

