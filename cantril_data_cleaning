#!#!/usr/bin/env bash
# Author: Andre Rampono
# Student: 23840638
set -x
# Data cleaning script to take three arguments, clean the data and send to STDOUT
# TODO Choose tsv checker


#: Check CLI for valid number of arguments
if [[ $# -ne 3 ]]
then
    echo "Usage: $0 <tsv datafile> <tsv datafile> <tsv datafile>." > /dev/stderr
    exit 1
fi

# Check file for validity
for arg in "$@"
do
    if [[ ! -s $arg ]]
    then
        echo "Error: The file $arg does not exist or is not readable." > /dev/stderr
        exit 1
    fi
done

# Check header line for a tab
for arg in "$@"
do
    if head -1 $arg | grep -q ' '
    then
        echo tsv
    else
        echo not a tsv
    fi
done

#TODO Add back code to check the tab separated heading and check each line for same number of cells


# loop through input files:
# - check the header for life, gdp and homicide
# - ignore rows outside date range and ignore rows without a country code
# - sort by entity and delete continent column from life and gdp
# - concat entity and year column to create unique column key
for arg in "$@"
do
    sed -n '1p' $arg > header_extract.tsv
    if grep -E -q [Ll]ife header_extract.tsv
    then
        echo In "$arg"
        awk -F'\t' '(int($3) < 2011 || int($3) > 2021) || $2 == ""{next;}{print $0}' $arg | sort -k1 -k3,3n | cut -f1-6 > "_life.tsv"
        awk 'BEGIN{FS="\t"; OFS=FS}{$7=$1$3}1' _life.tsv > _tmplife.tsv
    elif grep -E -q [Gg][Dd][Pp] header_extract.tsv
    then
        echo In "$arg"
        awk -F'\t' '(int($3) < 2011 || int($3) > 2021) || $2 == ""{next;}{print $0}' $arg | sort -k1 -k3,3n | cut -f1-6 > "_gdp.tsv"
        awk 'BEGIN{FS="\t"; OFS=FS}{$7=$1$3}1' _gdp.tsv > _tmpgdp.tsv
    elif grep -q [Hh]omicide header_extract.tsv
    then
        echo In "$arg"
        awk -F'\t' '(int($3) < 2011 || int($3) > 2021) || $2 == ""{next;}{print $0}' $arg | sort -k1,1 -k3,3n | cut -f1-4 > "_homicide.tsv"
        awk 'BEGIN{FS="\t"; OFS=FS}{$5=$1$3}1' _homicide.tsv > _tmphomicide.tsv
    fi
#TODO remove header_extract.tsv
#TODO remove temp files
done









































#TODO Implement a loop to compare the current line NF to the head NF and alert if different
for arg in "$@"
do
    num_tab=$(head -n1 $arg | awk '{print gsub(/\t/,"")}')
#    num_col=$(head -n1 $arg | awk '{print NF}')
    num_col=$(head -n1 $arg | awk -F'\t' '{print NF;exit}')

    echo $num_col
    awk -F'\t' '{print NF}' $arg
    awk -v cols=$num_col '{if (NF != cols) {printf"Line %d missing cells \n ", NR}}' $arg

#    awk -v cols=7  '{if (NF != cols) {printf"Line %d from file is bad  \n", NR}}' $arg
#    echo | awk '{print NF   }'
#    line_tab=$(awk '{print gsub(/\t/,"")}')
#    echo $line_tab
done




